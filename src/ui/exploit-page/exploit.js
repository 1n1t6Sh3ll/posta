import React from "react";
import ReactDOM from "react-dom";
import Editor from "../components/editor";
import Layout from '../components/layout'
import "./exploit.scss";
import Header from '../components/header';
const {decode } = require('js-base64').Base64;

export default class App extends React.Component {
  captureEditorSession(session) {
    this.editorSession = session;
    let _urlSearch = new URLSearchParams(location.search);
    try {
      let _code = _urlSearch.get("code");
      let code = _code ? decode(_urlSearch.get("code")) : "";
      this.editorSession.setValue(code);
      this.editorSession.setMode({
        v: Date.now(),
        path: "ace/mode/json"
      })

    } catch (error) {
      console.error(error);
    }
  }

  openAsTab(target){
    this.targetWindow = window.open(target)
  }

  exploit(){
    let payload = this.editorSession.getValue();
    try {
      payload = JSON.parse(payload)
    } catch (error) {
      
    }
    
    if (this.targetWindow && this.targetWindow.postMessage) this.targetWindow.postMessage(payload,"*")
    window.frames[0].postMessage(payload,"*");
  }

  render() {
    let _urlSearch = new URLSearchParams(location.search);
    let _target = _urlSearch.get("target");
    let target = _target ? decode(_target) : undefined 
    
    let {
      activeTarget=target,
      nextTarget=target
    } = this.state || {
      activeTarget:target,
      nextTarget:target
    };

    
    // ;
    return <>
    
    <Header></Header>
    
    <div className="target head">
      <input placeholder="Type in target Url" value={nextTarget} onChange={(e)=>this.setState({
        nextTarget:e.target.value
      })}></input>
      <button onClick={()=>this.setState({activeTarget:nextTarget})}>Set Target</button>
      {/* {target} */}
      </div>
    <div style={{height:"calc(100% - 120px)"}}>
    <Layout layout={
      [
        {
          w: 40,
          h: 90,
          content: <div className="frames">
            
            {activeTarget ? <>
              <div>{activeTarget}</div>
              <iframe style={{margin:"10px",width:"calc(100% - 20px)",height:"50%"}}  src={activeTarget}></iframe>
              <span>Iframe does not load? try<span className="open-tab-link" onClick={()=>this.openAsTab(activeTarget)}>Open as tab</span></span>
            </>:null}
          </div>
        },
        {
          w: 40,
          h: 10,
          content: <div className="actions">
            <button onClick={()=>this.exploit()}>Exploit</button>
          </div>
        },
        {
          w: 60,
          h: 100,
          content: <div style={{ maxHeight: "100%", backgroundColor: "#000000", height: "100%" }}>
            <Editor style={{ height: "100%", width: "100%" }} onMount={(session) => this.captureEditorSession(session)}></Editor>
          </div>
        }
      ]}
    ></Layout>
    </div>
    </>
  }
}

ReactDOM.render(<App></App>, document.getElementById("root"));